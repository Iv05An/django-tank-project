{% extends 'main/base.html' %}

{% block title %}–¢–∞–Ω–∫ –ò–°-3 - SOVIET TANKS{% endblock %}

{% block content %}
{% load static %}

<div class="article-section">
    <h2>–ò–°-3 ‚Äî –º–æ—â—å –∏ –±—Ä–æ–Ω—è —Å–æ–≤–µ—Ç—Å–∫–∏—Ö —Ç—è–∂—ë–ª—ã—Ö —Ç–∞–Ω–∫–æ–≤</h2>
    <p>–ò–°-3 (–ò–æ—Å–∏—Ñ –°—Ç–∞–ª–∏–Ω-3) ‚Äî —Å–æ–≤–µ—Ç—Å–∫–∏–π —Ç—è–∂—ë–ª—ã–π —Ç–∞–Ω–∫, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –≤ –∫–æ–Ω—Ü–µ –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π –≤–æ–π–Ω—ã –∏ —Å—Ç–∞–≤—à–∏–π –æ–¥–Ω–∏–º –∏–∑ —Å–∞–º—ã—Ö –ø–µ—Ä–µ–¥–æ–≤—ã—Ö –±–æ–µ–≤—ã—Ö –º–∞—à–∏–Ω —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –û–Ω –æ—Ç–ª–∏—á–∞–ª—Å—è —É—Å–∏–ª–µ–Ω–Ω–æ–π –±—Ä–æ–Ω–µ–≤–æ–π –∑–∞—â–∏—Ç–æ–π, –º–æ—â–Ω—ã–º –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ–º –∏ –Ω–æ–≤–æ–π, —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–π —Ñ–æ—Ä–º–æ–π –∫–æ—Ä–ø—É—Å–∞, –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–≤—à–µ–π –µ–≥–æ –∂–∏–≤—É—á–µ—Å—Ç—å –≤ –±–æ—é.</p>
    <img src="{% static 'images/scale_1200(1).jpeg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –ò–°-3">
    <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∏—è</h3>
    <p>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ò–°-3 –Ω–∞—á–∞–ª–∞—Å—å –≤ 1944 –≥–æ–¥—É —Å —É—á—ë—Ç–æ–º –æ–ø—ã—Ç–∞ –±–æ—ë–≤ –Ω–∞ –í–æ—Å—Ç–æ—á–Ω–æ–º —Ñ—Ä–æ–Ω—Ç–µ. –°–æ–≤–µ—Ç—Å–∫–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä—ã —Å—Ç—Ä–µ–º–∏–ª–∏—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∞–Ω–∫, —Å–ø–æ—Å–æ–±–Ω—ã–π –ø—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è—Ç—å –Ω–æ–≤–µ–π—à–µ–π –Ω–µ–º–µ—Ü–∫–æ–π —Ç–µ—Ö–Ω–∏–∫–µ, —Ç–∞–∫–æ–π –∫–∞–∫ ¬´–¢–∏–≥—Ä II¬ª. –í 1945 –≥–æ–¥—É –º–∞—à–∏–Ω–∞ –±—ã–ª–∞ –ø—Ä–∏–Ω—è—Ç–∞ –Ω–∞ –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ, –Ω–æ –≤ –±–æ–µ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π –≤–æ–π–Ω—ã –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–µ —É—Å–ø–µ–ª–∞. –û–¥–Ω–∞–∫–æ –µ—ë –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–µ–ª–æ —Å–∏–ª—å–Ω–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –Ω–∞ –ó–∞–ø–∞–¥, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –ü–∞—Ä–∞–¥–µ –ü–æ–±–µ–¥—ã –≤ –ë–µ—Ä–ª–∏–Ω–µ –≤ 1945 –≥–æ–¥—É.</p>
    <img src="{% static 'images/359060_14_pic_144.jpg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –ò–°-3">
    <h3>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
    <ul>
        <li><strong>–ö–ª–∞—Å—Å:</strong> —Ç—è–∂—ë–ª—ã–π —Ç–∞–Ω–∫</li>
        <li><strong>–≠–∫–∏–ø–∞–∂:</strong> 4 —á–µ–ª–æ–≤–µ–∫–∞</li>
        <li><strong>–í–æ–æ—Ä—É–∂–µ–Ω–∏–µ:</strong> 122-–º–º –ø—É—à–∫–∞ –î-25–¢</li>
        <li><strong>–ë—Ä–æ–Ω—è:</strong> –¥–æ 110 –º–º (–ª–æ–±–æ–≤–∞—è —á–∞—Å—Ç—å)</li>
        <li><strong>–î–≤–∏–≥–∞—Ç–µ–ª—å:</strong> –¥–∏–∑–µ–ª—å–Ω—ã–π –í-2-–ò–°, –º–æ—â–Ω–æ—Å—Ç—å—é 520 –ª.—Å.</li>
        <li><strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> –¥–æ 40 –∫–º/—á</li>
        <li><strong>–ó–∞–ø–∞—Å —Ö–æ–¥–∞:</strong> –¥–æ 150 –∫–º</li>
    </ul>
    <h3>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
    <p>–ì–ª–∞–≤–Ω–æ–π –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å—é –ò–°-3 —Å—Ç–∞–ª –Ω–æ–≤—ã–π –∫–æ—Ä–ø—É—Å —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ–π ¬´—â—É—á—å–µ–π¬ª —Ñ–æ—Ä–º–æ–π –ª–æ–±–æ–≤–æ–π –±—Ä–æ–Ω–∏, –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–≤—à–µ–π –∑–∞—â–∏—Ç—É –æ—Ç –≤—Ä–∞–∂–µ—Å–∫–∏—Ö —Å–Ω–∞—Ä—è–¥–æ–≤. –¢–∞–∫–∂–µ –±—ã–ª–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ –±–∞—à–Ω–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ –Ω–∏–∑–∫–æ–π –∏ –æ–±—Ç–µ–∫–∞–µ–º–æ–π, —á—Ç–æ —Å–Ω–∏–∂–∞–ª–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è.</p>
    <img src="{% static 'images/maxresdefault(1).jpg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –ò–°-3">
    <h3>–≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è –∏ –Ω–∞—Å–ª–µ–¥–∏–µ</h3>
    <p>–ò–°-3 –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ –∞—Ä–º–∏–∏ –°–°–°–† –∏ –ø–æ—Å—Ç–∞–≤–ª—è–ª—Å—è –≤ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã. –û–Ω —É—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ —Ä—è–¥–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –≤–∫–ª—é—á–∞—è –ë–ª–∏–∂–Ω–µ–≤–æ—Å—Ç–æ—á–Ω—ã–µ –≤–æ–π–Ω—ã –∏ —Å–æ–±—ã—Ç–∏—è –≤ –í–µ–Ω–≥—Ä–∏–∏ (1956). –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å–ª–æ–∂–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, —Ç–∞–Ω–∫ –æ—Å—Ç–∞–≤–∞–ª—Å—è –Ω–∞ –≤–æ–æ—Ä—É–∂–µ–Ω–∏–∏ –¥–æ–ª–≥–∏–µ –≥–æ–¥—ã, –∞ –µ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–æ–≤–µ—Ç—Å–∫–æ–π –±—Ä–æ–Ω–µ—Ç–µ—Ö–Ω–∏–∫–∏.</p>
    <img src="{% static 'images/6bef012s-960.jpg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –ò–°-3">
    <p>–°–µ–≥–æ–¥–Ω—è –ò–°-3 –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤ –º—É–∑–µ—è—Ö –∏ –ø–∞–º—è—Ç–Ω–∏–∫–∞—Ö, –æ–Ω –æ—Å—Ç–∞—ë—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º –º–æ—â–∏ —Å–æ–≤–µ—Ç—Å–∫–æ–π —Ç–∞–Ω–∫–æ–≤–æ–π —à–∫–æ–ª—ã –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–∞ —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>

    <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ -->
    <div class="like-dislike-section" style="margin: 20px 0;">
        <button id="like-btn" class="{% if user_liked %}active{% endif %}" {% if user_liked %}disabled{% endif %}>üëç <span id="likes-count">{{ likes }}</span></button>
        <button id="dislike-btn" class="{% if user_disliked %}active{% endif %}" {% if user_disliked %}disabled{% endif %}>üëé <span id="dislikes-count">{{ dislikes }}</span></button>
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="comments-section">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
        <div id="comments-list">
            {% for comment in comments %}
                <div class="comment" data-id="{{ comment.id }}">
                    <strong>{{ comment.username }}</strong> ({{ comment.created_at }}):
                    <p>{{ comment.content }}</p>
                </div>
            {% endfor %}
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="feedback-container">
            <h3>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <form id="comment-form" class="feedback-form">
                {% csrf_token %}
                <div class="form-group">
                    {{ comment_form.username.label_tag }}
                    {{ comment_form.username }}
                    <span class="error" id="username-error"></span>
                </div>
                <div class="form-group">
                    {{ comment_form.content.label_tag }}
                    {{ comment_form.content }}
                    <span class="error" id="comment-error"></span>
                </div>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<style>
.like-dislike-section button {
    padding: 8px 15px;
    margin-right: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
}
.like-dislike-section button span {
    margin-left: 5px;
    min-width: 20px;
    text-align: center;
}
.like-dislike-section button.active {
    background-color: #007bff;
    color: white;
}
.like-dislike-section button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}
.comments-section {
    margin-top: 20px;
}
.comment {
    border-bottom: 1px solid #ccc;
    padding: 10px 0;
    margin-bottom: 10px;
}
.feedback-container {
    margin-top: 20px;
}
.feedback-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.form-group {
    display: flex;
    flex-direction: column;
}
.form-group label {
    margin-bottom: 5px;
    font-weight: bold;
}
.form-group input,
.form-group textarea {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    display: block;
    width: 100%;
    box-sizing: border-box;
}
.form-group textarea {
    resize: vertical;
    min-height: 80px;
}
.form-group .error {
    color: red;
    font-size: 12px;
}
.feedback-form button {
    padding: 8px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    align-self: flex-start;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const commentsList = document.getElementById('comments-list');
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    const likesCount = document.getElementById('likes-count');
    const dislikesCount = document.getElementById('dislikes-count');
    const articleId = "{{ article.id }}";
    const contentTypeId = "{{ content_type_id }}";
    const slug = "{{ article.slug }}";

    // –û—Ç–ª–∞–¥–∫–∞
    console.log('Slug:', slug);
    console.log('WebSocket URL:', `${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/article/${slug}/`);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (!likeBtn || !dislikeBtn || !commentsList || !likesCount || !dislikesCount) {
        console.error('One or more DOM elements not found:', {
            likeBtn: !!likeBtn,
            dislikeBtn: !!dislikeBtn,
            commentsList: !!commentsList,
            likesCount: !!likesCount,
            dislikesCount: !!dislikesCount
        });
        return;
    }

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${wsProtocol}://${window.location.host}/ws/article/${slug}/`;
    const socket = new WebSocket(wsUrl);

    socket.onopen = () => {
        console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
    };

    socket.onmessage = (event) => {
        console.log('Received WebSocket message:', event.data);
        const data = JSON.parse(event.data);
        if (data.type === 'article_update') {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            commentsList.innerHTML = '';
            data.data.comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.dataset.id = comment.id;
                commentDiv.innerHTML = `
                    <strong>${comment.username}</strong> (${new Date(comment.created_at).toLocaleString()}):
                    <p>${comment.content}</p>
                `;
                commentsList.prepend(commentDiv);
            });
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
            likesCount.textContent = data.data.likes;
            dislikesCount.textContent = data.data.dislikes;
            likeBtn.classList.toggle('active', data.data.user_liked || false);
            dislikeBtn.classList.toggle('active', data.data.user_disliked || false);
            likeBtn.disabled = data.data.user_liked || false;
            dislikeBtn.disabled = data.data.user_disliked || false;
        }
    };

    socket.onclose = () => {
        console.error('WebSocket –∑–∞–∫—Ä—ã—Ç');
    };

    socket.onerror = (error) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const usernameInput = commentForm.querySelector('input[name="username"]');
            const contentInput = commentForm.querySelector('textarea[name="content"]');
            const username = usernameInput.value;
            const content = contentInput.value;

            if (!username.trim()) {
                document.getElementById('username-error').textContent = '–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                return;
            }
            if (!content.trim()) {
                document.getElementById('comment-error').textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                return;
            }

            fetch('{% url "add_comment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    article_id: articleId,
                    username: username,
                    content: content,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    usernameInput.value = '';
                    contentInput.value = '';
                    document.getElementById('username-error').textContent = '';
                    document.getElementById('comment-error').textContent = '';
                } else {
                    document.getElementById('comment-error').textContent = data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('comment-error').textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è';
            });
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
    function toggleLikeDislike(action) {
        likeBtn.disabled = true;
        dislikeBtn.disabled = true;

        fetch('{% url "toggle_like_dislike" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                content_type_id: contentTypeId,
                object_id: articleId,
                action: action,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                likesCount.textContent = data.likes;
                dislikesCount.textContent = data.dislikes;
                likeBtn.classList.toggle('active', data.user_liked || false);
                dislikeBtn.classList.toggle('active', data.user_disliked || false);
                likeBtn.disabled = data.user_liked || false;
                dislikeBtn.disabled = data.user_disliked || false;
            } else {
                console.error('–û—à–∏–±–∫–∞:', data.message);
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
        })
        .finally(() => {
            if (!likeBtn.classList.contains('active')) likeBtn.disabled = false;
            if (!dislikeBtn.classList.contains('active')) dislikeBtn.disabled = false;
        });
    }

    likeBtn.addEventListener('click', () => toggleLikeDislike('like'));
    dislikeBtn.addEventListener('click', () => toggleLikeDislike('dislike'));
});
</script>
{% endblock %}