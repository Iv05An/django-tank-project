{% extends 'main/base.html' %}
{% load static %}

{% block title %}–¢–∞–Ω–∫ –¢-34 - SOVIET TANKS{% endblock %}

{% block content %}

<div class="article-section">
    <h2>–¢-34 ‚Äî –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Ç–∞–Ω–∫ –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π –≤–æ–π–Ω—ã</h2>
    <p>–¢-34 ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∞–Ω–∫–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏, —Å–∏–º–≤–æ–ª —Å–æ–≤–µ—Ç—Å–∫–æ–π –±—Ä–æ–Ω–µ—Ç–µ—Ö–Ω–∏–∫–∏ –∏ –∫–ª—é—á–µ–≤–∞—è –±–æ–µ–≤–∞—è –º–∞—à–∏–Ω–∞ –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω—ã. –û–Ω —Å–æ—á–µ—Ç–∞–ª –≤ —Å–µ–±–µ –ø–µ—Ä–µ–¥–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è, –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ—Ç–æ—Ä—ã–º —Å—Ç–∞–ª –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–º –º–∞—Å—Å–æ–≤—ã–º —Å—Ä–µ–¥–Ω–∏–º —Ç–∞–Ω–∫–æ–º –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π, –Ω–æ –∏ –æ–¥–Ω–∏–º –∏–∑ —Å–∞–º—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö.</p>
    <img src="{% static 'images/scale_1200.jpeg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –¢-34">
    <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∏—è</h3>
    <p>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢-34 –Ω–∞—á–∞–ª–∞—Å—å –≤ 1937 –≥–æ–¥—É –Ω–∞ –•–∞—Ä—å–∫–æ–≤—Å–∫–æ–º –∑–∞–≤–æ–¥–µ ‚Ññ 183 –ø–æ–¥ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ú–∏—Ö–∞–∏–ª–∞ –ö–æ—à–∫–∏–Ω–∞. –ù–æ–≤—ã–π —Ç–∞–Ω–∫ –¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–º–µ–Ω–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤–∞—é—â–∏–π –ë–¢-7 –∏ –æ–±–ª–∞–¥–∞—Ç—å –≤—ã—Å–æ–∫–æ–π –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å—é, –º–æ—â–Ω—ã–º –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ–º –∏ –Ω–∞–¥—ë–∂–Ω–æ–π –±—Ä–æ–Ω—ë–π. –í 1940 –≥–æ–¥—É –¢-34 –±—ã–ª –ø—Ä–∏–Ω—è—Ç –Ω–∞ –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ –ö—Ä–∞—Å–Ω–æ–π –∞—Ä–º–∏–∏, –∞ –µ–≥–æ —Å–µ—Ä–∏–π–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–æ—Å—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–≤–æ–¥–∞—Ö.</p>

    <img src="{% static 'images/242613_195_pic_278.jpg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –¢-34">

    <h3>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
    <ul>
        <li><strong>–ö–ª–∞—Å—Å:</strong> —Å—Ä–µ–¥–Ω–∏–π —Ç–∞–Ω–∫</li>
        <li><strong>–≠–∫–∏–ø–∞–∂:</strong> 4 —á–µ–ª–æ–≤–µ–∫–∞</li>
        <li><strong>–í–æ–æ—Ä—É–∂–µ–Ω–∏–µ:</strong> 76,2-–º–º –ø—É—à–∫–∞ (–Ω–∞ —Ä–∞–Ω–Ω–∏—Ö –º–æ–¥–µ–ª—è—Ö), 85-–º–º –ø—É—à–∫–∞ (–¢-34-85)</li>
        <li><strong>–ë—Ä–æ–Ω—è:</strong> –¥–æ 75 –º–º (–≤ –ø–æ–∑–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö)</li>
        <li><strong>–î–≤–∏–≥–∞—Ç–µ–ª—å:</strong> –¥–∏–∑–µ–ª—å–Ω—ã–π –í-2, –º–æ—â–Ω–æ—Å—Ç—å—é 500 –ª.—Å.</li>
        <li><strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> –¥–æ 55 –∫–º/—á</li>
        <li><strong>–ó–∞–ø–∞—Å —Ö–æ–¥–∞:</strong> –¥–æ 300 –∫–º</li>
    </ul>

    <h3>–†–æ–ª—å –≤ –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω–µ</h3>
    <p>–° –ø–µ—Ä–≤—ã—Ö –¥–Ω–µ–π –≤–æ–π–Ω—ã –¢-34 –¥–æ–∫–∞–∑–∞–ª —Å–≤–æ—ë –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ –Ω–∞–¥ –Ω–µ–º–µ—Ü–∫–∏–º–∏ —Ç–∞–Ω–∫–∞–º–∏. –ï–≥–æ –Ω–∞–∫–ª–æ–Ω–Ω–∞—è –±—Ä–æ–Ω—è –ª—É—á—à–µ –ø—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è–ª–∞ —Å–Ω–∞—Ä—è–¥–∞–º, –∞ –º–æ—â–Ω–∞—è –ø—É—à–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø–æ—Ä–∞–∂–∞–ª–∞ —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞. –û–¥–Ω–∞–∫–æ —Ä–∞–Ω–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–∞–¥–∞–ª–∏ –æ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ —Å–ª–∞–±–∞—è –æ–±–∑–æ—Ä–Ω–æ—Å—Ç—å –∏ –Ω–µ—Ö–≤–∞—Ç–∫–∞ —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–π. –í 1943 –≥–æ–¥—É –ø–æ—è–≤–∏–ª–∞—Å—å –º–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¢-34-85 —Å —É—Å–∏–ª–µ–Ω–Ω–æ–π –±—Ä–æ–Ω—ë–π –∏ –Ω–æ–≤—ã–º –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ–º, —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ —É–≤–µ—Ä–µ–Ω–Ω–æ –±–æ—Ä–æ—Ç—å—Å—è —Å ¬´–¢–∏–≥—Ä–∞–º–∏¬ª –∏ ¬´–ü–∞–Ω—Ç–µ—Ä–∞–º–∏¬ª.</p>
    <img src="{% static 'images/maxresdefault.jpg' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –¢-34">
    <h3>–ù–∞—Å–ª–µ–¥–∏–µ –¢-34</h3>
    <p>–ü–æ—Å–ª–µ –≤–æ–π–Ω—ã –¢-34 –æ—Å—Ç–∞–≤–∞–ª—Å—è –Ω–∞ –≤–æ–æ—Ä—É–∂–µ–Ω–∏–∏ –º–Ω–æ–≥–∏—Ö —Å—Ç—Ä–∞–Ω –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –º–Ω–æ–≥–æ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö. –ï–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–æ—Å—å –¥–æ 1950-—Ö –≥–æ–¥–æ–≤, –∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –≤–ø–ª–æ—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ XX –≤–µ–∫–∞. –°–µ–≥–æ–¥–Ω—è –¢-34 —è–≤–ª—è–µ—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º –ø–æ–±–µ–¥—ã –∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –≤ –º—É–∑–µ—è—Ö –∏ –ø–∞–º—è—Ç–Ω–∏–∫–∞—Ö –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.</p>
    <img src="{% static 'images/368384_O.png' %}" class="blurred-edges" alt="–¢–∞–Ω–∫ –¢-34">
    <p>–¢-34 —Å—Ç–∞–ª –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞–Ω–∫–æ–º, –∞ –ª–µ–≥–µ–Ω–¥–æ–π, –¥–æ–∫–∞–∑–∞–≤, —á—Ç–æ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ—Ç—ã, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –±–æ–µ–≤–æ–π –º–æ—â–∏ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ö–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏.</p>

    <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ -->
<div class="like-dislike-section" style="margin: 20px 0;">
    <button id="like-btn" class="{% if user_liked %}active{% endif %}" {% if user_liked %}disabled{% endif %}>üëç <span id="likes-count">{{ likes }}</span></button>
    <button id="dislike-btn" class="{% if user_disliked %}active{% endif %}" {% if user_disliked %}disabled{% endif %}>üëé <span id="dislikes-count">{{ dislikes }}</span></button>
</div>

<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
<div class="comments-section">
    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
    <div id="comments-list">
        {% for comment in comments %}
            <div class="comment" data-id="{{ comment.id }}">
                <strong>{{ comment.username }}</strong> ({{ comment.created_at }}):
                <p>{{ comment.content }}</p>
            </div>
        {% endfor %}
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="feedback-container">
        <h3>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
        <form id="comment-form" class="feedback-form">
            {% csrf_token %}
            <div class="form-group">
                {{ comment_form.username.label_tag }}
                {{ comment_form.username }}
                <span class="error" id="username-error"></span>
            </div>
            <div class="form-group">
                {{ comment_form.content.label_tag }}
                {{ comment_form.content }}
                <span class="error" id="comment-error"></span>
            </div>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

</div>


<style>
.like-dislike-section button {
    padding: 8px 15px;
    margin-right: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
}
.like-dislike-section button span {
    margin-left: 5px;
    min-width: 20px;
    text-align: center;
}
.like-dislike-section button.active {
    background-color: #007bff;
    color: white;
}
.like-dislike-section button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}
.comments-section {
    margin-top: 20px;
}
.comment {
    border-bottom: 1px solid #ccc;
    padding: 10px 0;
    margin-bottom: 10px;
}
.feedback-container {
    margin-top: 20px;
}
.feedback-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.form-group {
    display: flex;
    flex-direction: column;
}
.form-group label {
    margin-bottom: 5px;
    font-weight: bold;
}
.form-group input,
.form-group textarea {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    display: block;
    width: 100%;
    box-sizing: border-box;
}
.form-group textarea {
    resize: vertical;
    min-height: 80px;
}
.form-group .error {
    color: red;
    font-size: 12px;
}
.feedback-form button {
    padding: 8px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    align-self: flex-start;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const commentsList = document.getElementById('comments-list');
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    const likesCount = document.getElementById('likes-count');
    const dislikesCount = document.getElementById('dislikes-count');
    const articleId = "{{ article.id }}";
    const contentTypeId = "{{ content_type_id }}";
    const slug = "{{ article.slug }}";

    // –û—Ç–ª–∞–¥–∫–∞
    console.log('Slug:', slug);
    console.log('WebSocket URL:', `${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/article/${slug}/`);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (!likeBtn || !dislikeBtn || !commentsList || !likesCount || !dislikesCount) {
        console.error('One or more DOM elements not found:', {
            likeBtn: !!likeBtn,
            dislikeBtn: !!dislikeBtn,
            commentsList: !!commentsList,
            likesCount: !!likesCount,
            dislikesCount: !!dislikesCount
        });
        return;
    }

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${wsProtocol}://${window.location.host}/ws/article/${slug}/`;
    const socket = new WebSocket(wsUrl);

    socket.onopen = () => {
        console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
    };

    socket.onmessage = (event) => {
        console.log('Received WebSocket message:', event.data);
        const data = JSON.parse(event.data);
        if (data.type === 'article_update') {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            commentsList.innerHTML = '';
            data.data.comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.dataset.id = comment.id;
                commentDiv.innerHTML = `
                    <strong>${comment.username}</strong> (${new Date(comment.created_at).toLocaleString()}):
                    <p>${comment.content}</p>
                `;
                commentsList.prepend(commentDiv);
            });
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
            likesCount.textContent = data.data.likes;
            dislikesCount.textContent = data.data.dislikes;
            likeBtn.classList.toggle('active', data.data.user_liked || false);
            dislikeBtn.classList.toggle('active', data.data.user_disliked || false);
            likeBtn.disabled = data.data.user_liked || false;
            dislikeBtn.disabled = data.data.user_disliked || false;
        }
    };

    socket.onclose = () => {
        console.error('WebSocket –∑–∞–∫—Ä—ã—Ç');
    };

    socket.onerror = (error) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const usernameInput = commentForm.querySelector('input[name="username"]');
            const contentInput = commentForm.querySelector('textarea[name="content"]');
            const username = usernameInput.value;
            const content = contentInput.value;

            if (!username.trim()) {
                document.getElementById('username-error').textContent = '–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                return;
            }
            if (!content.trim()) {
                document.getElementById('comment-error').textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                return;
            }

            fetch('{% url "add_comment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    article_id: articleId,
                    username: username,
                    content: content,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    usernameInput.value = '';
                    contentInput.value = '';
                    document.getElementById('username-error').textContent = '';
                    document.getElementById('comment-error').textContent = '';
                } else {
                    document.getElementById('comment-error').textContent = data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('comment-error').textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è';
            });
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
    function toggleLikeDislike(action) {
        likeBtn.disabled = true;
        dislikeBtn.disabled = true;

        fetch('{% url "toggle_like_dislike" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                content_type_id: contentTypeId,
                object_id: articleId,
                action: action,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                likesCount.textContent = data.likes;
                dislikesCount.textContent = data.dislikes;
                likeBtn.classList.toggle('active', data.user_liked || false);
                dislikeBtn.classList.toggle('active', data.user_disliked || false);
                likeBtn.disabled = data.user_liked || false;
                dislikeBtn.disabled = data.user_disliked || false;
            } else {
                console.error('–û—à–∏–±–∫–∞:', data.message);
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
        })
        .finally(() => {
            if (!likeBtn.classList.contains('active')) likeBtn.disabled = false;
            if (!dislikeBtn.classList.contains('active')) dislikeBtn.disabled = false;
        });
    }

    likeBtn.addEventListener('click', () => toggleLikeDislike('like'));
    dislikeBtn.addEventListener('click', () => toggleLikeDislike('dislike'));
});
</script>
{% endblock %}